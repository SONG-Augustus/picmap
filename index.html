<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ì§€ë°˜ ì¡°ì‚¬ ì¢…í•© ì§€ë„</title>
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=40f614ea3ff4bf0ed09944ae699802fa&libraries=services&autoload=false"></script>
  <style>
    body { font-family: 'Noto Sans KR', sans-serif; margin: 0; padding: 0; overflow: hidden; }
    
    /* ìƒë‹¨ ì»¨íŠ¸ë¡¤ ë°” */
    .controls {
      background: #333; color: white; padding: 10px 20px;
      display: flex; align-items: center; gap: 10px; height: 50px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    h2 { margin: 0; font-size: 18px; margin-right: 20px; white-space: nowrap; }
    
    #btn-container { display: flex; gap: 5px; overflow-x: auto; padding-bottom: 2px; }
    
    /* ì—°ë„ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .year-btn {
      background: #555; color: #ddd; border: 1px solid #777;
      padding: 6px 12px; cursor: pointer; border-radius: 4px;
      transition: all 0.2s; font-size: 14px; white-space: nowrap;
    }
    .year-btn:hover { background: #777; color: white; }
    .year-btn.active { background: #00C853; color: white; border-color: #00C853; font-weight: bold; }
    
    #map { width: 100%; height: calc(100vh - 70px); position: relative; }
    
    /* ë¡œë”© ì°½ */
    #loading {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center;
      color: white; font-size: 20px; z-index: 2000;
    }

    /* ì´ˆê¸° ì•ˆë‚´ ë¬¸êµ¬ */
    #intro-msg {
      position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
      background: rgba(255,255,255,0.9); padding: 20px 40px; border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2); text-align: center; z-index: 500;
      font-size: 18px; font-weight: bold; color: #333; pointer-events: none;
    }

    /* ë²”ë¡€ */
    .map-legend {
      position: absolute; bottom: 20px; right: 20px; background: rgba(255,255,255,0.95);
      padding: 15px; border-radius: 10px; z-index: 10; font-size: 13px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }
    .legend-item { display: flex; align-items: center; margin: 5px 0; }
    .legend-color { width: 15px; height: 15px; border-radius: 50%; margin-right: 8px; }
    
    /* ì´ë¯¸ì§€ ëª¨ë‹¬ */
    #imageModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999; justify-content: center; align-items: center; }
    #modalImage { max-width: 95%; max-height: 95%; border: 2px solid white; }
    .info-image { width: 100%; max-width: 250px; margin-top: 5px; cursor: pointer; border-radius: 4px; }
  </style>
</head>
<body>

  <div class="controls">
    <h2>ğŸ—ºï¸ ì§€ë°˜ ì¡°ì‚¬ ì§€ë„</h2>
    <div id="btn-container">
      </div>
    <div style="flex-grow:1;"></div>
    <button onclick="toggleMapType()" style="cursor:pointer; padding:5px 10px; background:#444; color:white; border:none; border-radius:4px;">ğŸ›° ìœ„ì„±/ì§€ë„</button>
  </div>

  <div id="loading">ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
  
  <div id="map">
    <div id="intro-msg">ğŸ‘† ìƒë‹¨ ë²„íŠ¼ì„ ëˆŒëŸ¬ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì„¸ìš”</div>

    <div class="map-legend">
      <strong>ë²”ë¡€</strong>
      <div class="legend-item"><div class="legend-color" style="background:#808080;"></div>ì–‘í˜¸ <span class="cnt-good">0</span></div>
      <div class="legend-item"><div class="legend-color" style="background:#00C853;"></div>ì¼ë°˜ <span class="cnt-normal">0</span></div>
      <div class="legend-item"><div class="legend-color" style="background:#FFD600;"></div>ìš°ì„  <span class="cnt-priority">0</span></div>
      <div class="legend-item"><div class="legend-color" style="background:#D50000;"></div>ê¸´ê¸‰ <span class="cnt-urgent">0</span></div>
      <div class="legend-item"><div class="legend-color" style="background:#2196F3;"></div>GPR <span class="cnt-gpr">0</span></div>
    </div>
  </div>

  <div id="imageModal"><img id="modalImage" src=""></div>

  <script>
    // ==========================================
    // âš ï¸ êµ¬ê¸€ ì•±ìŠ¤ ìŠ¤í¬ë¦½íŠ¸ URL (ê·¸ëŒ€ë¡œ ìœ ì§€)
    // ==========================================
    const DATA_SERVER_URL = "https://script.google.com/macros/s/AKfycbwC3IVpDY0q_V3IKSd3LJ3V9wBvYjPw3oeSWRVJ9GQv_kKvOe8j-eegzwNcpKn1L6H3/exec";

    let map, isHybrid = true, markers = [];
    let gradeCount = { good: 0, normal: 0, priority: 0, urgent: 0, gpr: 0 };

    // 1. ì´ˆê¸°í™” ë° ë²„íŠ¼ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
    // 1. ì´ˆê¸°í™” ë° ë²„íŠ¼ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
    window.onload = function() {
      
      // [í•µì‹¬] ì¹´ì¹´ì˜¤ ë§µì´ ì¤€ë¹„ë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¼
      kakao.maps.load(async function() {
        initMap(); // ì§€ë„ ë¨¼ì € ê·¸ë¦¬ê¸°
        
        try {
          // GASì— íŒŒì¼ ëª©ë¡ ìš”ì²­
          const response = await fetch(`${DATA_SERVER_URL}?action=getList`);
          const fileList = await response.json();
          
          const container = document.getElementById('btn-container');
          document.getElementById('loading').style.display = 'none';

          if(fileList.length === 0) {
            alert("í´ë”ì— êµ¬ê¸€ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.");
            return;
          }

          // ë²„íŠ¼ ìƒì„±
          fileList.forEach((file) => {
            const btn = document.createElement('button');
            btn.className = 'year-btn';
            btn.textContent = file.name;
            btn.onclick = () => loadSheetData(file.id, btn);
            container.appendChild(btn);
          });
        } catch (e) {
          console.error(e);
          document.getElementById('loading').innerText = "ë°ì´í„° ëª©ë¡ ë¡œë”© ì‹¤íŒ¨ (ìƒˆë¡œê³ ì¹¨ í•˜ì„¸ìš”)";
        }
      }); // kakao.maps.load ë
      
    };

    // 2. ì—‘ì…€ ë°ì´í„° ë¶ˆëŸ¬ì™€ì„œ ì§€ë„ì— ê·¸ë¦¬ê¸° (ë²„íŠ¼ í´ë¦­ ì‹œ ì‹¤í–‰)
    async function loadSheetData(fileId, btnElement) {
      // ì•ˆë‚´ ë¬¸êµ¬ ìˆ¨ê¸°ê¸°
      const introMsg = document.getElementById('intro-msg');
      if(introMsg) introMsg.style.display = 'none';

      // ë²„íŠ¼ ìŠ¤íƒ€ì¼ í™œì„±í™”
      document.querySelectorAll('.year-btn').forEach(b => b.classList.remove('active'));
      btnElement.classList.add('active');
      
      // ë¡œë”© í™”ë©´ í‘œì‹œ
      document.getElementById('loading').textContent = "ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...";
      document.getElementById('loading').style.display = 'flex';
      
      try {
        const response = await fetch(`${DATA_SERVER_URL}?action=getData&fileId=${fileId}`);
        const data = await response.json();
        
        // ê¸°ì¡´ ë§ˆì»¤ ì‚­ì œ ë° ì´ˆê¸°í™”
        markers.forEach(m => m.setMap(null));
        markers = [];
        gradeCount = { good: 0, normal: 0, priority: 0, urgent: 0, gpr: 0 };
        
        // ë°ì´í„° ì²˜ë¦¬ (mainData í•„ë“œ í™•ì¸)
        if (data.mainData && data.mainData.length > 0) {
           processRows(data.mainData);
        } else {
           alert("ë°ì´í„°ê°€ ì—†ê±°ë‚˜ ì‹œíŠ¸ í˜•ì‹ì´ ë§ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        }
        
        updateLegend();
        document.getElementById('loading').style.display = 'none'; // ë¡œë”© ë
        
      } catch (e) {
        alert("ë°ì´í„° ë¡œë”© ì‹¤íŒ¨: " + e);
        document.getElementById('loading').style.display = 'none';
      }
    }

    function processRows(rows) {
      rows.forEach(row => {
        if (!row.lat || !row.lng) return;
        
        const pos = new kakao.maps.LatLng(row.lat, row.lng);
        let color = "#808080", shape = "circle", size = 20;
        
        // Fì—´(grade) ê°’ìœ¼ë¡œ ìŠ¤íƒ€ì¼ ê²°ì •
        const grade = String(row.grade || "");

        if (grade.includes("ì‹œì¢…ì ")) { shape = "triangle"; color = "#D50000"; size = 15; }
        else if (grade.includes("ì¼ë°˜")) { color = "#00C853"; gradeCount.normal++; }
        else if (grade.includes("ìš°ì„ ")) { color = "#FFD600"; gradeCount.priority++; }
        else if (grade.includes("ê¸´ê¸‰")) { color = "#D50000"; gradeCount.urgent++; }
        else if (grade.includes("GPR") || grade.includes("ê´€ì°°")) { color = "#2196F3"; gradeCount.gpr++; }
        else { gradeCount.good++; }

        const marker = new kakao.maps.Marker({
          position: pos,
          image: createMarkerShape(shape, size, color),
          map: map
        });
        markers.push(marker);

        // ì¸í¬ìœˆë„ìš° ë‚´ìš©
        // [ì¤‘ìš”] convertDriveLink í•¨ìˆ˜ ì‚¬ìš©
        const imgUrl = convertDriveLink(row.img);
        
        const content = `
          <div style="padding:10px; min-width:200px; font-size:12px;">
            <strong style="font-size:14px;">${row.name || "ì§€ì "}</strong><br>
            <span style="color:${color}">â—</span> ${grade}<br>
            ${imgUrl ? `<img src="${imgUrl}" class="info-image">` : ""}
            <p style="margin:5px 0 0; color:#666;">${row.desc || ""}</p>
          </div>
        `;
        const infowindow = new kakao.maps.InfoWindow({ content: content, removable: true });
        kakao.maps.event.addListener(marker, 'click', () => infowindow.open(map, marker));
      });
    
    }

    // [ìˆ˜ì •ë¨] êµ¬ê¸€ ë“œë¼ì´ë¸Œ ì¸ë„¤ì¼ ë§í¬ ë³€í™˜ (ì—‘ìŠ¤ë°•ìŠ¤ í•´ê²°)
    function convertDriveLink(url) {
      if (!url) return "";
      url = String(url);
      const match = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
      if (match && match[1]) {
        // sz=w1000 ì€ ë„ˆë¹„ 1000px ê³ í™”ì§ˆ ì¸ë„¤ì¼ ìš”ì²­
        return `https://drive.google.com/thumbnail?id=${match[1]}&sz=w1000`;
      }
      return url;
    }

    function initMap() {
      map = new kakao.maps.Map(document.getElementById('map'), {
        center: new kakao.maps.LatLng(37.52783, 126.84887), level: 7
      });
    }
    
    function toggleMapType() {
      map.setMapTypeId(isHybrid ? kakao.maps.MapTypeId.ROADMAP : kakao.maps.MapTypeId.SKYVIEW);
      isHybrid = !isHybrid;
    }

    function createMarkerShape(type, size, color) {
      const c = document.createElement("canvas");
      c.width = size; c.height = size;
      const ctx = c.getContext("2d");
      ctx.beginPath();
      if(type==="circle") ctx.arc(size/2, size/2, size/2-1, 0, Math.PI*2);
      else { ctx.moveTo(size/2,0); ctx.lineTo(0,size); ctx.lineTo(size,size); }
      ctx.fillStyle = color; ctx.fill(); 
      ctx.strokeStyle = "#fff"; ctx.stroke();
      return new kakao.maps.MarkerImage(c.toDataURL(), new kakao.maps.Size(size,size));
    }

    function updateLegend() {
      document.querySelector(".cnt-good").innerText = gradeCount.good;
      document.querySelector(".cnt-normal").innerText = gradeCount.normal;
      document.querySelector(".cnt-priority").innerText = gradeCount.priority;
      document.querySelector(".cnt-urgent").innerText = gradeCount.urgent;
      document.querySelector(".cnt-gpr").innerText = gradeCount.gpr;
    }

    // ì´ë¯¸ì§€ í´ë¦­ ì‹œ í™•ëŒ€ (ëª¨ë‹¬)
    document.addEventListener("click", e => {
      if (e.target.classList.contains("info-image")) {
        document.getElementById("modalImage").src = e.target.src;
        document.getElementById("imageModal").style.display = "flex";
      }
    });
    document.getElementById("imageModal").onclick = () => document.getElementById("imageModal").style.display = "none";
  </script>
</body>

</html>

